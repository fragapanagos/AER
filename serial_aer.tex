\documentclass{article}
\usepackage{mystyle}

\begin{document}
\title{Serialized Tree AER}
\author{Sam Fok}
\maketitle

The neuron address packet is serialized as a series of 1-of-N words. 
We use an additional line (making the total data lines 1-of-(N+1)) to indicate the completion of a packet.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Transmitter ($AEXT$)}

The transmitter is organized as a tree. Packets travel from the leaves of the tree to the root. At each node, incoming packet streams are merged into a single output stream. Each packet is prepended with a word indicating which branch it came from. To merge the streams, incoming packets from different branches are output one after the other. 

\begin{csp}
NODE\equiv
*[[h->
    [#{C0}->s:=0,P!(0);
    \|#{C1}->s:=1,P!(1)];
    h:=false
  []~h->
    [s=0->C0?x;P!x
    []s=1->C1?x;P!x
    ];h:=x.tail
 ]]
\end{csp}

We divide NODE into FWD and MERGE processes. 
FWD prepends a word to the packet indicating which branch the packet is coming from.
MERGE arbitrates between incoming packet streams and outputs them one at a time.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{FWD version hq}

This version has fewer state variables than version 2, but the pull-up and pull-down chains are too long.

%%%%%%%%%%%%%%%
\subsubsection*{CHP}

\begin{csp}
FWD\equiv
  h:=true;
  *[[h&#{X}->Y!(\textrm{header});h-
    []~h&#{X}->Y!(X?)\*[X=t->h+];
    ]
   ]
\end{csp}

%%%%%%%%%%%%%%%
\subsubsection*{HSE}

\begin{hse}
h:=true;
*[h&(x0|x1|xt)->yn+;[yi];q+;yn-;[~yi];h-;q-
  []~h&x0->y0+;xo+;[yi];y0-;[~x0];xo-;[~yi]
  []~h&x1->y1+;xo+;[yi];y1-;[~x1];xo-;[~yi]
  []~h&xt->yt+;xo+;[yi];h+;yt-;[~xt];xo-;[~yi]
\end{hse}

%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
h & yi & yn -> q+
~h -> q-

yt & xo & yi -> h+
q & ~yi -> h-
\end{prs2}

\begin{prs2}
~h & (y0 | y1 | yt) -> xo+
~x0 & ~x1 & ~xt & ~y0 & ~y1 & ~yt -> xo-
\end{prs2}

\begin{prs2}
h & ~q & ~yi & ~xo & (x0 | xi | xt) -> yn+
q -> yn-
\end{prs2}

\begin{prs2}
~h & ~q & ~yi & x0 & ~xo -> y0+
yi & xo -> y0-

~h & ~q & ~yi & x1 & ~xo -> y1+
yi & xo -> y1-
\end{prs2}

\begin{prs2}
~h & ~q & ~yi & xt & ~xo -> yt+
h & xo -> yt-
\end{prs2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{FWD version hu}

This version has more state variables than version 1, but has reasonable pull-up and pull-down chains.

%%%%%%%%%%%%%%%
\subsubsection*{CHP}

\begin{csp}
FWD\equiv
  *[[h&#{X}->Y!(\textrm{header});h-
    []~h&#{X}->X?u\*Y!u,[u=t->h+]
    ]
   ]
\end{csp}

%%%%%%%%%%%%%%%
\subsubsection*{HSE}

\begin{hse}
*[[h&(x0|x1|xt)->yn+;[yi];h-;yn-;[~yi]
  []~h&x0->u0+;(xo+;[~x0]),(y0+;[yi]);u0-;(y0-;[~yi]),xo-
  []~h&x1->u1+;(xo+;[~x1]),(y1+;[yi]);u1-;(y1-;[~yi]),xo-
  []~h&xt->ut+;(xo+;[~xt]),(yt+;h+;[yi]);ut-;(yt-;[~yi]),xo-
\end{hse}

\begin{hse}
*[[h&(x0|x1|xt)->yn+;[yi];h-;yn-;[~yi]
  []~h&x0->u0+;[~x0&yi];u0-;[~yi]
  []~h&x1->u1+;[~x1&yi];u1-;[~yi]
  []~h&xt->ut+;[~xt&h&yi];ut-;[~yi]

*[u0->xo+,y0+;[~u0];y0-,xo-
  []u1->xo+,y1+;[~u1];y1-,xo-
  []ut->xo+,(yt+;h+);[ut-];yt-,xo-
\end{hse}

%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
yt -> h+
yn & yi -> h-
\end{prs2}

\begin{prs2}
h & (x0 | x1 | xt) & ~yi & ~yt -> yn+
~h & yi & ~un -> yn-
\end{prs2}

\begin{prs2}
u0 | u1 | ut -> xo+
~u0 & ~u1 & ~ut -> xo-
\end{prs2}

\begin{prs2}
~h & x0 & ~yi -> u0+
~x0 & yi -> u0-

~h & x1 & ~yi -> u1+
~x1 & yi -> u1-
\end{prs2}

\begin{prs2}
~h & xt & ~yi -> ut+
h & ~xt & yi -> ut-
\end{prs2}

\begin{prs2}
u0 -> y0+
~h & ~u0 -> y0-

u1 -> y1+
~h & ~u1 -> y1-
\end{prs2}

\begin{prs2}
ut -> yt+
~ut -> yt-
\end{prs2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Leaf interface LEAF\_INT}

LEAF\_INT interfaces with the neuron and outputs a tail word to get the party started.

%%%%%%%%%%%%%%%
\subsubsection*{CHP}
\begin{csp}
LEAF_INT\equiv
  *[C\star\!P!\textrm{tail};C\star\!P!\textrm{tail}]
\end{csp}

%%%%%%%%%%%%%%%
\subsubsection*{HSE}
\begin{hse}
*[[ci];{po}`t+;[pi]co+;
  [~ci];{po}`t-;[~pi];co-]
\end{hse}

%%%%%%%%%%%%%%%
\subsubsection*{PRS}
\begin{prs2}
ci -> {po}`t+
~ci -> {po}`t-

pi -> co+
~pi -> co-
\end{prs2}

\noindent These are just wires...

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{MERGE}

MERGE sequences between outputting two serialized packet streams.

\begin{csp}
MERGE\equiv
  *[[~l&~r->
      [#{L}->l:=true
      \|#{R}->r:=true
      ]
    []l|r->
      [l->O!(L?)
      []r->O!(R?)
    ]
  ]
\end{csp}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{MERGE version a\_a}

I don't like this version because the pullup chains for the state variables
are too long and won't scale to higher radix encoding.

%%%%%%%%%%%%%%%
\subsubsection*{CHP}

\begin{csp}
MERGE\equiv
  *[[h->[#{C0}->a:=0\|#{C1}->a:=1];h-
    []~h&a=0->P!(C0?)
    []~h&a=0->P!(C1?)
    ]]
\end{csp}

%%%%%%%%%%%%%%%
\subsubsection*{HSE}

\begin{hse}
*[[~ao&~a1&(c00|c01|c0t)->a0+
  \|~a0&~a1&(c10|c11|c1t)->a1+]]

*[[ a0&c00->p0+;c0o+;[pi&~c00];p0-;c0o-;[~pi]
  []a0&c01->p1+;c0o+;[pi&~c01];p1-;c0o-;[~pi]
  []a0&c0t->pt+;c0o+;[pi&~c0t];a0-;pt-;c0o-;[~pi]
  []a1&c10->p0+;c1o+;[pi&~c10];p0-;c1o-;[~pi]
  []a1&c11->p1+;c1o+;[pi&~c11];p1-;c1o-;[~pi]
  []a1&c1t->pt+;c1o+;[pi&~c1t];a1-;pt-;c1o-;[~pi]
  ]]
\end{hse}
%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
~a0 & (c00 | c01| c0t) & ~c0o -> a0i+
a0 -> a0i-

~a1 & (c10 | c11| c1t) & ~c1o -> a1i+
a1 -> a1i-

a0o & ~a1 & ~c1o & ~pi -> a0+ % uhoh will depend on other a's
~a0o & pi & pt & ~c0t -> a0-

a1o & ~a0 & ~c0o & ~pi -> a1+
~a1o & pi & pt & ~c1t -> a1-
\end{prs2}

\begin{prs2}
~pi & (a0 & c00 | a1 & c10) -> p0+
pi & (~_a0 & ~c00 | ~_a1 & ~c10) -> p0-

~pi & (a0 & c01 | a1 & c11) -> p1+
pi & (~_a0 & ~c01 | ~_a1 & ~c11) -> p1-

~pi & (a0 & c0t | a1 & c1t) -> pt+
_a0 & _a1 -> pt-
\end{prs2}

\begin{prs2}
a0 & (p0 | p1 | pt) -> c0o+
~p0 & ~p1 & ~pt -> c0o-

a1 & (p0 | p1 | pt) -> c1o+
~p0 & ~p1 & ~pt -> c1o-
\end{prs2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{MERGE version ah}

This one has acceptable pullup/pulldown chains, but I'm worried about making it CMOS implementable

%%%%%%%%%%%%%%%
\subsubsection*{HSE}

\begin{hse}
*[[~a0&(c00|c01|c0t)->a0+;h-;[~a0];h+
  \|~a1&(c10|c11|c1t)->a1+;h-;[~a1];h+]]

*[[ a0&c00->p0+;c0o+;[pi&~c00];p0-;c0o-;[~pi]
  []a0&c01->p1+;c0o+;[pi&~c01];p1-;c0o-;[~pi]
  []a0&c0t->pt+;c0o+;[pi&~c0t];a0-;pt-;c0o-;[~pi]
  []a1&c10->p0+;c1o+;[pi&~c10];p0-;c1o-;[~pi]
  []a1&c11->p1+;c1o+;[pi&~c11];p1-;c1o-;[~pi]
  []a1&c1t->pt+;c1o+;[pi&~c1t];a1-;pt-;c1o-;[~pi]
  ]]
\end{hse}

%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
(c00 | c01| c0t) & ~a0 -> a0i+
~h & a0 -> a0i-

(c10 | c11| c1t) & ~a1-> a1i+
~h & a1 -> a1i-

h & a0o & ~pi -> a0+
pt & pi & c0o & ~c0t & ~a0o -> a0-

h & a1o & ~pi -> a1+
pt & pi & c1o & ~c1t & ~a1o -> a1-
\end{prs2}

\begin{prs2}
~a0 & ~a1 -> h+
a0 | a1 & ~c0o & ~c1o-> h-
\end{prs2}

\begin{prs2}
~pi & (a0 & c00 | a1 & c10) & ~h -> p0+
pi & (a0 & ~c00 | a1 & ~c10) -> p0-

~pi & (a0 & c01 | a1 & c11) & ~h -> p1+
pi & (a0 & ~c01 | a1 & ~c11) -> p1-

~pi & (a0 & c0t | a1 & c1t) & ~h -> pt+
~a0 & ~a1 -> pt-
\end{prs2}

\begin{prs2}
a0 & (p0 | p1 | pt) -> c0o+
~p0 & ~p1 & ~pt -> c0o-

a1 & (p0 | p1 | pt) -> c1o+
~p0 & ~p1 & ~pt -> c1o-
\end{prs2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Receiver ($AERV$)}

We'll used the decomposed into BCAST and FILTER version for now.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{BCAST pipelined}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{CHP}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{HSE}

strict cpcp

\begin{hse}
BCAST\equiv
*[[ p0->c00+,c10+;po+;[c0i&c1i&~p0];c00-,c10-;po-;[~c0i&~c1i];
  []p1->c01+,c11+;po+;[c0i&c1i&~p1];c01-,c11-;po-;[~c0i&~c1i];
  []pt->c0t+,c1t+;po+;[c0i&c1i&~pt];c0t-,c1t-;po-;[~c0i&~c1i];
 ]]
\end{hse}

\begin{hse}
BCAST\equiv
*[[ p0->q0+;c00+,c10+;po+;[c0i&c1i&~p0];q0-;c00-,c10-;po-;[~c0i&~c1i]
  []p1->q1+;c01+,c11+;po+;[c0i&c1i&~p1];q1-;c01-,c11-;po-;[~c0i&~c1i]
  []pt->qt+;c0t+,c1t+;po+;[c0i&c1i&~pt];qt-;c0t-,c1t-;po-;[~c0i&~c1i]
 ]]
\end{hse}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
q0 -> c00+
~q0 -> c00-

q1 -> c01+
~q1 -> c01-

qt -> c0t+
~qt -> c0t-

q0 -> c10+
~q0 -> c10-

q1 -> c11+
~q1 -> c11-

qt -> c1t+
~qt -> c1t-
\end{prs2}

\begin{prs2}
~c0i & ~c1i & p0 -> q0+
c0i & c1i & ~p0 -> q0-

~c0i & ~c1i & p1 -> q1+
c0i & c1i & ~p1 -> q1-

~c0i & ~c1i & pt -> qt+
c0i & c1i & ~pt -> qt-
\end{prs2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{HSE}

output ordering cpcp
parallelized

\begin{hse}
BCAST\equiv
*[[ p0->([~c0i];c00+),([~c1i];c10+);po+;[~p0];([c0i];c00-),([c1i];c10-);po-;
  []p1->([~c0i];c01+),([~c1i];c11+);po+;[~p1];([c0i];c01-),([c1i];c11-);po-;
  []pt->([~c0i];c0t+),([~c1i];c1t+);po+;[~pt];([c0i];c0t-),([c1i];c1t-);po-;
 ]]
\end{hse}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
~c0i & p0 -> c00+
c0i & ~p0 -> c00-

~c0i & p1 -> c01+
c0i & ~p1 -> c01-

~c0i & pt -> c0t+
c0i & ~pt -> c0t-

~c1i & p0 -> c10+
c1i & ~p0 -> c10-

~c1i & p1 -> c11+
c1i & ~p1 -> c11-

~c1i & pt -> c1t+
c1i & ~pt -> c1t-
\end{prs2}

\begin{prs2}
VN(C) -> po+
~VN(C) -> po-
\end{prs2}

po is the output of a VN detector

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{HSE}

swap ordering of p and c in reset
output ordering cppc
parallelized

\begin{hse}
BCAST\equiv
*[[ p0->([~c0i];c00+),([~c1i];c10+);(po+;[~p0];po-);([c0i];c00-),([c1i];c10-)
  []p1->([~c0i];c01+),([~c1i];c11+);(po+;[~p1];po-);([c0i];c01-),([c1i];c11-)
  []pt->([~c0i];c0t+),([~c1i];c1t+);(po+;[~pt];po-);([c0i];c0t-),([c1i];c1t-)
 ]]
\end{hse}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
~c0i & p0 -> c00+
c0i & ~p0 & ~po -> c00-

~c0i & p1 -> c01+
c0i & ~p1 & ~po -> c01-

~c0i & pt -> c0t+
c0i & ~pt & ~po -> c0t-

~c1i & p0 -> c10+
c1i & ~p0 & ~po -> c10-

~c1i & p1 -> c11+
c1i & ~p1 & ~po -> c11-

~c1i & pt -> c1t+
c1i & ~pt & ~po -> c1t-
\end{prs2}

\begin{prs2}
(c00 & c10 | c01 & c11 | c0t & c1t) & (p0 | p1 | pt) -> po+
~p0 & ~p1 & ~pt -> po-
\end{prs2}

instability on down phases of c because p input can rise at anytime
Could probably fix with state variables.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{BCAST unpipelined}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{CHP}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{HSE}

\begin{hse}
BCAST\equiv
*[[ p0->c00+,c10+;[c0i&c1i];po+;[~p0];c00-,c10-;[~c0i&~c1i];po-
  []p1->c01+,c11+;[c0i&c1i];po+;[~p1];c01-,c11-;[~c0i&~c1i];po-
  []pt->c0t+,c1t+;[c0i&c1i];po+;[~pt];c0t-,c1t-;[~c0i&~c1i];po-
 ]]
\end{hse}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{PRS}

\begin{prs2}
p0 -> c00+
~p0 -> c00-

p1 -> c01+
~p1 -> c01-

pt -> c0t+
~pt -> c0t-

p0 -> c10+
~p0 -> c10-

p1 -> c11+
~p1 -> c11-

pt -> c1t+
~pt -> c1t-
\end{prs2}

\begin{prs2}
c0i & c1i -> po+
~c0i & ~c1i -> po-
\end{prs2}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{document}
